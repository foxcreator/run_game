---
# Role: github-runner — Встановлення та налаштування Self-Hosted Runner

- name: Create runner user
  user:
    name: runner
    shell: /bin/bash
    groups: sudo
    append: yes
    create_home: yes

- name: Allow runner user passwordless sudo for specific commands
  copy:
    dest: /etc/sudoers.d/runner
    content: |
      runner ALL=(ALL) NOPASSWD: /usr/sbin/service nginx reload, /usr/bin/systemctl reload nginx, /usr/bin/pm2
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Create runner directory
  file:
    path: /home/runner/actions-runner
    state: directory
    owner: runner
    group: runner
    mode: '0755'

- name: Install runner dependencies
  apt:
    name:
      - libdigest-sha-perl
      - libicu-dev
      - libssl-dev
    state: present

- name: Download GitHub Runner
  get_url:
    url: https://github.com/actions/runner/releases/download/v2.313.0/actions-runner-linux-x64-2.313.0.tar.gz
    dest: /home/runner/actions-runner/actions-runner-linux.tar.gz
    owner: runner
    group: runner
    mode: '0644'

- name: Extract GitHub Runner
  unarchive:
    src: /home/runner/actions-runner/actions-runner-linux.tar.gz
    dest: /home/runner/actions-runner
    remote_src: yes
    owner: runner
    group: runner
    creates: /home/runner/actions-runner/config.sh

- name: Check if runner is already configured
  stat:
    path: /home/runner/actions-runner/.runner
  register: runner_configured

- name: Configure GitHub Runner
  command:
    cmd: ./config.sh --url https://github.com/foxcreator/run_game --token {{ runner_token }} --unattended --replace
    chdir: /home/runner/actions-runner
  become_user: runner
  when: not runner_configured.stat.exists and runner_token is defined

- name: Install Runner Service
  command:
    cmd: ./svc.sh install
    chdir: /home/runner/actions-runner
  become: yes
  when: not runner_configured.stat.exists and runner_token is defined
  ignore_errors: yes # Service might be already installed

- name: Start Runner Service
  command:
    cmd: ./svc.sh start
    chdir: /home/runner/actions-runner
  become: yes
  ignore_errors: yes # Might be already running
