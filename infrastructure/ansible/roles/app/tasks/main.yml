---
# Role: app - налаштування додатку

- name: Clone repository
  git:
    repo: "{{ app_repo | default('https://github.com/foxcreator/run_game.git') }}"
    dest: "{{ app_dir }}"
    version: "{{ app_branch | default('main') }}"
    force: yes
  become_user: "{{ deploy_user }}"

- name: Set directory permissions
  file:
    path: "{{ app_dir }}"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    recurse: yes

- name: Install server npm dependencies
  npm:
    path: "{{ app_dir }}/server"
    state: present
  become_user: "{{ deploy_user }}"

- name: Create .env file
  template:
    src: env.j2
    dest: "{{ app_dir }}/server/.env"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0600'

- name: Run Prisma generate
  command: npx prisma generate
  args:
    chdir: "{{ app_dir }}/server"
  become_user: "{{ deploy_user }}"

- name: Run Prisma migrations
  command: npx prisma db push
  args:
    chdir: "{{ app_dir }}/server"
  environment:
    DATABASE_URL: "mysql://root:{{ mysql_root_password }}@localhost:3306/{{ mysql_database }}"
  become_user: "{{ deploy_user }}"

- name: Create PM2 ecosystem config
  template:
    src: ecosystem.config.js.j2
    dest: "{{ app_dir }}/server/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"

- name: Start API with PM2
  command: pm2 start ecosystem.config.js
  args:
    chdir: "{{ app_dir }}/server"
  become_user: "{{ deploy_user }}"

- name: Save PM2 process list
  command: pm2 save
  become_user: "{{ deploy_user }}"
