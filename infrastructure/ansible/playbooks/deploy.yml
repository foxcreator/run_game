---
# Деплой коду (без перевстановлення системи)
- name: Deploy Busification Run
  hosts: all
  become: true
  
  tasks:
    - name: Pull latest code
      git:
        repo: "{{ app_repo }}"
        dest: "{{ app_dir }}"
        version: main
        force: yes
      become_user: "{{ deploy_user }}"
    
    - name: Install server dependencies
      npm:
        path: "{{ app_dir }}/server"
        state: present
      become_user: "{{ deploy_user }}"
    
    - name: Run Prisma migrations
      command: npx prisma db push
      args:
        chdir: "{{ app_dir }}/server"
      environment:
        DATABASE_URL: "mysql://root:{{ mysql_root_password }}@localhost:3306/{{ mysql_database }}"
      become_user: "{{ deploy_user }}"
    
    - name: Restart API service
      systemd:
        name: busification-api
        state: restarted
        daemon_reload: yes
