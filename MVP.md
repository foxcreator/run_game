MVP A (Top-down endless chase) — ТЗ для реалізації по кроках

0) Definition of Done (DoD) MVP

MVP готовий, коли:
	•	є меню → гра → результат → магазин апгрейдів;
	•	сесія триває нескінченно до програшу (шкала “захоплення” 0–100);
	•	працює процедурний спавн перешкод + підбиралок + переслідувачів;
	•	є 2 типи переслідувачів, 6 перешкод, 4 бонуси, 3 події;
	•	є мета-прогрес (гроші зберігаються) + апгрейди (зберігаються);
	•	є локальний рекорд;
	•	гра відчувається динамічно: ривок, стаміна, комбо-множник, росте складність.

⸻

1) Підзадача: Базова структура проєкту

1.1 Структура файлів
	•	/index.html
	•	/src/main.js (точка входу)
	•	/src/scenes/BootScene.js
	•	/src/scenes/MenuScene.js
	•	/src/scenes/GameScene.js
	•	/src/scenes/ResultScene.js
	•	/src/scenes/ShopScene.js
	•	/src/systems/Spawner.js (логіка спавну)
	•	/src/systems/Difficulty.js (крива складності + події)
	•	/src/systems/Save.js (localStorage)
	•	/src/entities/Player.js
	•	/src/entities/ChaserBlocker.js
	•	/src/entities/ChaserSticker.js
	•	/src/entities/Pickups.js (гроші/бонуси)
	•	/src/entities/Obstacles.js
	•	/src/ui/HUD.js

1.2 Acceptance criteria
	•	Запуск у браузері → відкривається меню.
	•	Перехід “Start” → GameScene.
	•	З GameScene по програшу → ResultScene.
	•	З ResultScene можна в ShopScene і назад у Menu.

⸻

2) Підзадача: Візуальний стиль (мінімум)

2.1 Арт для MVP

Щоб Cursor не застряг на графіці:
	•	використовуй примітиви (rect/circle) або 1–2 прості спрайти.
	•	кольори/іконки можна замінити потім.

2.2 Acceptance criteria
	•	Гравець видимий, вороги видимі, перешкоди видимі, пікапи видимі.
	•	Нема “невидимих зіткнень” (hitbox ≈ sprite).

⸻

3) Підзадача: Player — рух, стаміна, ривок, ковзання

3.1 Параметри (дефолт)
	•	baseSpeed = 220
	•	staminaMax = 100
	•	stamina = staminaMax
	•	staminaDrainPerSec = 6
	•	staminaRegenPerSec = 4
	•	exhaustedSlowDuration = 2.0 sec
	•	exhaustedSpeedMultiplier = 0.75

Dash
	•	dashDuration = 0.35 sec
	•	dashSpeedMultiplier = 1.7
	•	dashCooldown = 4.0 sec
	•	dashStaminaCost = 20

Slide (під стрічку)
	•	slideDuration = 0.45 sec
	•	slideCooldown = 2.0 sec
	•	slideSpeedMultiplier = 1.1
	•	під час slide hitbox по висоті умовно менший (або просто “canPassTape=true” на час)

3.2 Правила
	•	Рух завжди плавний (velocity/acceleration).
	•	Стаміна:
	•	якщо гравець рухається → drain
	•	якщо стоїть/дуже повільно → regen швидше (опційно x1.2)
	•	Якщо stamina <= 0 → тригер “exhausted”:
	•	на 2 сек speedMultiplier = 0.75
	•	stamina ставиться = 15 (щоб не зависнути в нулі)

3.3 Acceptance criteria
	•	Гравець керується WASD.
	•	Dash працює і має cooldown.
	•	Stamina зменшується/відновлюється адекватно.
	•	Exhausted відчувається як покарання, але не “смерть”.

3.4 Підзадача: Карта світу — tilemap 4000×4000 з колізіями (MVP)

Загальна концепція

Світ гри — одна фіксована карта міста, НЕ процедурна.

Розмір світу: 4000 × 4000 px.

Реалізація через tilemap (32×32 px).

Карта є базовим шаром гри; всі системи зобовʼязані враховувати її колізії.

Типи тайлів (кольорові заглушки MVP)

Тип

Колір

Прохідність

Road

Сірий

Прохідний

Sidewalk

Жовтий

Прохідний

Yard

Зелений

Прохідний

Building

Червоний

Колізія

Kiosk

Синій

Колізія

Fence / Wall

Чорний

Колізія

Кольори — тимчасові заглушки. Пізніше замінюються спрайтами без зміни логіки.

Шари tilemap

ground — Road, Sidewalk, Yard (без колізій)

buildings — Building, Kiosk, Fence/Wall (колізії увімкнені)

Правила колізій

Гравець і всі вороги не можуть заходити на тайли шару buildings.

Вороги не колайдяться між собою.

Колізія фізична: ковзання вздовж стін, без телепортацій.

Камера

Камера слідує за гравцем.

Camera bounds = 4000×4000.

Камера не показує простір за межами карти.

Інтеграція зі спавнером

Всі процедурні обʼєкти спавняться поверх tilemap.

Перед спавном обовʼязково:

world → tile координати;

перевірка, що тайл НЕ з шару buildings.

Tilemap — єдине джерело правди щодо прохідності.

Acceptance criteria

Видно різні типи тайлів різними кольорами.

Неможливо зайти в колізійні тайли.

Жоден обʼєкт не спавниться в будівлях.

Додатково реалізовано:

• Міні-карта (справа знизу) з відображенням всієї карти, позиції гравця та поточного viewport
• Система кіосків: рівно 5 кіосків на карті (конфігурується через gameConfig.js)
• Логіка взаємодії з кіосками: заморозка гравця на 2 секунди, відновлення стаміни, зникнення кіоска та респавн через 20 секунд
• Виправлено систему depth: HUD завжди поверх кіосків та інших об'єктів (depth 200+)
• Оптимізовано рендеринг tilemap: використання одного Graphics об'єкта замість тисяч окремих спрайтів
• Органічна генерація міста: синусоїдальні дороги, квартали будівель, тротуари
• Правильна обробка колізій: гравець не може проходити крізь будівлі, але не застрягає біля них
• SoftCrowd (черга людей) - перешкода з дебафом швидкості (65% на 1 секунду)
• Базовий клас Obstacle для майбутніх перешкод
• Система спавну перешкод на прохідних позиціях карти

⸻

4) Підзадача: Система програшу через “захоплення” (0–100)

4.1 Основна ідея

Не миттєвий програш при торканні — а шкала захоплення, що росте коли вороги дуже близько.

4.2 Формула зростання/спаду

Кожен кадр (delta):
	•	знайти minDistance до будь-якого переслідувача.
	•	якщо minDistance < 60 → capture += 18 * dt
	•	якщо minDistance < 35 → capture += 35 * dt
	•	якщо minDistance > 120 → capture -= 22 * dt
	•	clamp 0..100

Додатково:
	•	бонус “Жарт” → capture -= 30 миттєво
	•	удар “стікера” → capture += 25 миттєво

4.3 Acceptance criteria
	•	Можна “відірватись”, шкала реально спадає.
	•	Програш тільки коли шкала досягла 100.

⸻

5) Підзадача: Перешкоди (6 типів) + колізії

5.1 Перелік і поведінка
	1.	Кіоск (StaticBlock)
	•	суцільний блок.
	2.	Черга людей (SoftCrowd)
	•	колізія не зупиняє повністю, а дає дебафф:
	•	speed *= 0.65 на 1.0 sec.
	3.	Калюжа (PuddleSlip)
	•	на 0.7 сек зменшує керованість:
	•	або turning/accel *= 0.6, або додає “інерцію”.
	4.	Стрічка/шлагбаум (TapeGate)
	•	якщо гравець НЕ в slide → блокує (як кіоск)
	•	якщо в slide → пропускає.
	5.	Маршрутка (MovingBus)
	•	рухається по прямій між 2 точками, циклічно.
	•	колізія як кіоск (жорстка).
	6.	Пачка паперів (PaperStack)
	•	при торканні: короткий стагер 0.2 sec (micro slow),
	•	і спавнить 3–6 дрібних монет поруч (ризик/нагорода).

5.2 Acceptance criteria
	•	Колізії стабільні, не “телепортять” крізь об’єкти.
	•	TapeGate реально проходиться тільки slide.

⸻

6) Підзадача: Пікапи (гроші + 4 бонуси)

6.1 Гроші
	•	“Banked money” (мета) + “Run money” (за забіг).
	•	За забіг додається в мета після смерті.

6.2 Бонуси (MVP 4)
	1.	Енергетик

	•	stamina += 35 (clamp до max)

	2.	Скутер (2.0 sec)

	•	speedMultiplier += 0.5
	•	імунітет до SoftCrowd на час

	3.	Жарт (мем)

	•	capture -= 30
	•	всі вороги speed *= 0.7 на 1.0 sec

	4.	Димова хмарка

	•	вороги “втрачають лок” на 1.2 sec:
	•	вони не зникають, просто рухаються до “останньої відомої позиції” 1.2 сек

6.3 Acceptance criteria
	•	Пікапи зникають після підбору.
	•	Ефекти працюють по таймерам і коректно скидаються.

⸻

7) Підзадача: Два типи переслідувачів (AI простий, але чесний)

7.1 Загальні правила
	•	Вороги не повинні “читерити”:
	•	не спавнити прямо впритул
	•	не мати швидкість сильно > гравця надовго
	•	Вороги повинні штовхати гравця на помилки через траєкторії, а не через “миттєве хапання”.

7.2 Тип 1: Blocker (“перекривач”)

Ціль: обганяти і ставати попереду на прогнозованій точці.
	•	speed = 190..210 (скейлиться складністю)
	•	Логіка:
	•	бере напрямок руху гравця (velocity normalized).
	•	цілиться у точку playerPos + dir * leadDistance, де leadDistance 120–180.
	•	рухається туди.
	•	Якщо близько до гравця (<50) → відходить убік, щоб не “липнути” постійно.

7.3 Тип 2: Sticker (“прилипала”)

Ціль: наздогнати і зробити “удар”.
	•	speed = 230..255 (скейлиться)
	•	Логіка:
	•	рухається безпосередньо на playerPos.
	•	якщо торкнувся:
	•	capture += 25
	•	відскакує назад на 30px і дає собі hitCooldown = 1.5 sec (щоб не спамив)

7.4 Acceptance criteria
	•	Відчувається різниця між типами ворогів.
	•	Нема "нескінченного стунлоку" від Sticker.
	•	Blocker реально змушує маневрувати.

Додатково реалізовано:
	•	ChaserBlocker (перекривач) - прогнозує позицію гравця та обганяє попереду
	•	ChaserSticker (прилипала) - наздоганяє гравця та робить удар (+25 capture)
	•	Система обходу перешкод (PathfindingSystem) - вороги обходять будівлі та інші перешкоди
	•	Колізії ворогів з тайлами карти - вороги не проходять крізь будівлі
	•	Всі параметри ворогів винесені в конфіг з детальними коментарями
	•	Налаштований спавн ворогів на відстані від гравця з перевіркою валідності позицій

Додатково реалізовано:
	•	ChaserBlocker (перекривач) - прогнозує позицію гравця та обганяє попереду
	•	ChaserSticker (прилипала) - наздоганяє гравця та робить удар (+25 capture)
	•	Система обходу перешкод (PathfindingSystem) - вороги обходять будівлі та інші перешкоди
	•	Колізії ворогів з тайлами карти - вороги не проходять крізь будівлі
	•	Всі параметри ворогів винесені в конфіг з детальними коментарями
	•	Налаштований спавн ворогів на відстані від гравця з перевіркою валідності позицій

⸻

8) Підзадача: Процедурний спавн мапи (ключ до веселощів)

8.1 Підхід

Не генеруємо “повний лабіринт”. Робимо арену, де:
	•	гравець приблизно в центрі,
	•	контент спавниться в “кільці” навколо,
	•	і прибирається, коли далеко позаду.

8.2 Зони спавну (важливо!)
	•	SafeRadius навколо гравця: 90px — тут не спавнити перешкоди/ворогів.
	•	SpawnRingMin: 220px
	•	SpawnRingMax: 520px
	•	Точки спавну вибираємо в цьому кільці.

8.3 Рейти спавну (стартові)

Кожну секунду перевірка:
	•	Перешкоди: підтримувати 20–28 активних
	•	Пікапи-гроші: 6–10 активних
	•	Бонуси: 1–3 активних (рідко)
	•	Вороги: старт 2 → росте до 5–6

8.4 Валідація позиції (anti-frustration)

Перед створенням об’єкта:
	•	не ближче SafeRadius
	•	не перетинається з іншими великими об’єктами
	•	не блокує повністю шлях (евристика):
	•	навколо точки має бути “прохід” шириною хоча б 80px (простий тест: не ставити 2 великі блоки надто близько)

8.5 Acceptance criteria
	•	Нема спавну прямо в гравця.
	•	Мапа не стає “непрохідною”.
	•	Завжди є можливість маневру.

⸻

9) Підзадача: Складність і події (3 штуки)

9.1 Крива складності (простий таймер)

timeSurvivedSec росте.
Кожні 20 сек:
	•	+1 до “ChaosLevel”

Вплив ChaosLevel:
	•	кількість ворогів cap: 2 + floor(ChaosLevel/2) (макс 6)
	•	швидкість ворогів +3% за рівень
	•	частота перешкод +5% за рівень (але cap, щоб не захлинулась)

9.2 Події (кожні 25–35 сек)

Вибрати випадково, тривалість 6–10 сек:
	1.	Дощ

	•	puddles spawn rate x1.8
	•	керованість гравця -10% (легко)

	2.	Ремонт

	•	kiosks + tapeGate частіше
	•	грошей трохи більше (компенсація)

	3.	Свято

	•	грошей +30%
	•	+1 тимчасовий ворог на час події

9.3 Acceptance criteria
	•	Складність зростає відчутно, але не стрибком.
	•	Події відрізняються і помітні гравцю (HUD повідомлення).

⸻

10) Підзадача: Score, гроші, комбо-множник

10.1 Score
	•	score += 1 кожні 0.1 сек (тобто +10/сек)
	•	score += moneyPicked (1$ = +1 score)

10.2 Комбо-множник (ризик = вигода)

Якщо capture > 60 → multiplier 1.5
Якщо capture > 80 → multiplier 2.0
Інакше 1.0

Застосування:
	•	всі гроші та очки за час множаться на multiplier (або тільки гроші — на твій смак).

10.3 Acceptance criteria
	•	Гравець бачить multiplier в HUD.
	•	Ризик реально “вигідний”.

⸻

11) Підзадача: Shop / апгрейди / сейв

11.1 Апгрейди (5)
	1.	staminaMax +10 (5 рівнів)
	2.	staminaRegen +0.6/sec (5 рівнів)
	3.	dashCooldown -0.3 sec (4 рівні, мінімум 2.8)
	4.	baseSpeed +8 (5 рівнів)
	5.	luck +3% (5 рівнів) — впливає на шанс бонусів

11.2 Ціни (рівні)
	•	L1 $250
	•	L2 $600
	•	L3 $1200
	•	L4 $2200
	•	L5 $3500

11.3 Save format (localStorage)

Зберігаємо:
	•	bankMoney
	•	bestScore
	•	upgrades: { stamina, regen, dash, speed, luck }
	•	totalEarned (опційно)
	•	unlockedFinalRun (bankMoney >= 20000)

11.4 Acceptance criteria
	•	Гроші і апгрейди не зникають після перезавантаження сторінки.
	•	Покупка змінює реальні параметри в GameScene.

⸻

12) Підзадача: HUD та UX (щоб “весело”)

HUD показує:
	•	Stamina bar
	•	Capture bar
	•	Money this run + Bank money
	•	Score + Best score
	•	Dash cooldown індикатор
	•	Active buff icons
	•	Поточна подія (toast зверху)

UX правила:
	•	кожен pickup дає короткий “pop” ефект (анімка/звук — мінімально)
	•	камера може трохи “трястись” на зіткненні (легенько)

Acceptance:
	•	Без HUD гра не відчувається — з HUD відчувається як аркада.

⸻

13) Підзадача: “Фінальний забіг” (простий режим)

Коли bankMoney >= 20000:
	•	відкривається кнопка Final Run в меню.
	•	Final Run = 90 сек вижити при підвищеній складності (ChaosLevel стартує з 6).
	•	Якщо вижив:
	•	показати “Victory”
	•	зафіксувати прапор finalCompleted=true
	•	дати косметичну нагороду (наприклад, інший колір гравця) — без контенту

Acceptance:
	•	Є чітка мета і “крапка”, але гра залишається endless для рекордів.

⸻

14) Порядок реалізації 

Ось прям ідеальний порядок комітів/кроків:
	1.	✅ Skeleton + сцени (Menu/Game/Result/Shop)
	2.	✅ Player movement + stamina + dash + HUD stamina
	3.	✅ Capture bar + програш через 100 + Карта світу — tilemap 4000×4000 з колізіями (MVP)
	4.	✅ Obstacle 1–2 (кіоск + черга) + колізії
	5.	✅ 2 типи ворогів (Sticker + Blocker) з базовим AI
	6.	Spawner ring + safe radius + cleanup
	7.	✅ Всі 6 перешкод
	8.	Гроші + 4 бонуси + таймери ефектів
	9.	Difficulty + ChaosLevel
	10.	3 події (дощ/ремонт/свято)
	11.	Score + multiplier
	12.	Shop + upgrades + Save/Load
	13.	Final Run
	14.	Полірування: баланс, дрібні FX, відчуття